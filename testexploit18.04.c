#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <pwd.h>

#define DEBUG

#ifdef DEBUG
#define dprintf printf
#else
#define dprintf(...)
#endif

static const char *SHELL = "/bin/bash";
static const char *pkexec_path = "/usr/bin/pkexec";

int spawn_shell() {
    struct passwd *pw = getpwuid(getuid());
    if (pw == NULL) {
        dprintf("[-] getpwuid: Failed to retrieve username\n");
        exit(EXIT_FAILURE);
    }

    dprintf("[+] Spawning shell...\n");
    execl(pkexec_path, "pkexec", "--user", pw->pw_name, SHELL, NULL);
    perror("[-] execl: Failed to spawn shell");
    exit(EXIT_FAILURE);
}

int main() {
    pid_t child_pid;

    dprintf("[+] Trying to spawn a root shell...\n");

    if ((child_pid = fork()) < 0) {
        perror("[-] fork");
        exit(EXIT_FAILURE);
    }

    if (child_pid == 0) {
        spawn_shell();
    } else {
        wait(NULL);
    }

    dprintf("[+] Shell process completed\n");

    return 0;
}
